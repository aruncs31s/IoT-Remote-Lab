{% extends "base.html" %}

{% block title %}ESP Simulator - IoT Remote Lab{% endblock %}

{% block page_title %}üî¨ ESP Device Simulator{% endblock %}
{% block page_subtitle %}Test and Simulate ESP Device Behavior{% endblock %}

{% block extra_css %}
/* Simulator specific styles */
.simulator-panel {
    background: var(--ctp-surface1);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--ctp-surface2);
}

.simulator-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.control-group {
    background: var(--ctp-surface0);
    padding: 15px;
    border-radius: 8px;
}

.control-group h4 {
    color: var(--ctp-text);
    margin-bottom: 10px;
    font-size: 1rem;
}

.control-input {
    width: 100%;
    padding: 8px 12px;
    background: var(--ctp-surface2);
    border: 1px solid var(--ctp-overlay0);
    border-radius: 6px;
    color: var(--ctp-text);
    font-size: 0.9rem;
}

.control-input:focus {
    outline: none;
    border-color: var(--ctp-mauve);
    box-shadow: 0 0 0 2px rgba(203, 166, 247, 0.2);
}

.simulator-output {
    background: var(--ctp-surface0);
    border-radius: 8px;
    padding: 15px;
    font-family: 'JetBrains Mono', 'Monaco', monospace;
    font-size: 0.85rem;
    color: var(--ctp-text);
    border: 1px solid var(--ctp-surface2);
    height: 300px;
    overflow-y: auto;
}

.output-line {
    margin-bottom: 5px;
}

.output-line.info {
    color: var(--ctp-blue);
}

.output-line.warning {
    color: var(--ctp-yellow);
}

.output-line.error {
    color: var(--ctp-red);
}

.output-line.success {
    color: var(--ctp-green);
}

.simulator-status {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--ctp-red);
}

.status-dot.running {
    background: var(--ctp-green);
    animation: pulse 2s infinite;
}

.virtual-device {
    background: var(--ctp-surface1);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 2px solid var(--ctp-surface2);
}

.device-display {
    background: var(--ctp-surface0);
    border-radius: 8px;
    padding: 20px;
    margin: 15px 0;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: monospace;
    font-size: 1.2rem;
    color: var(--ctp-text);
}

.led-indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    margin: 0 5px;
    border: 2px solid var(--ctp-overlay0);
}

.led-indicator.on {
    background: var(--ctp-green);
    box-shadow: 0 0 10px rgba(166, 227, 161, 0.6);
}

.led-indicator.off {
    background: var(--ctp-surface2);
}
{% endblock %}

{% block content %}
    {% if error %}
    <div class="alert-error">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <div class="section-header">
        <h2>ESP Device Simulator</h2>
        <div class="simulator-status">
            <span class="status-dot" id="simulatorStatus"></span>
            <span id="statusText">Simulator Stopped</span>
            <button class="btn btn-primary" id="toggleSimulator" onclick="toggleSimulator()">
                ‚ñ∂Ô∏è Start Simulator
            </button>
        </div>
    </div>

    <div class="simulator-panel">
        <h3 style="color: var(--ctp-text); margin-bottom: 15px;">üì° Virtual ESP32 Device</h3>
        
        <div class="virtual-device">
            <h4 style="color: var(--ctp-text);">ESP32-DevKit</h4>
            
            <div class="device-display" id="deviceDisplay">
                ESP32 Ready
            </div>
            
            <div style="margin: 15px 0;">
                <span>Built-in LED: </span>
                <span class="led-indicator off" id="builtinLED"></span>
                <span>GPIO2: </span>
                <span class="led-indicator off" id="gpio2LED"></span>
                <span>GPIO4: </span>
                <span class="led-indicator off" id="gpio4LED"></span>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Control Panel -->
        <div class="simulator-panel">
            <h3 style="color: var(--ctp-text); margin-bottom: 15px;">‚öôÔ∏è Control Panel</h3>
            
            <div class="simulator-controls">
                <div class="control-group">
                    <h4>GPIO Controls</h4>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="toggleGPIO(2)">
                        Toggle GPIO2
                    </button>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="toggleGPIO(4)">
                        Toggle GPIO4
                    </button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="toggleBuiltinLED()">
                        Toggle Built-in LED
                    </button>
                </div>

                <div class="control-group">
                    <h4>WiFi Simulation</h4>
                    <input type="text" class="control-input" placeholder="WiFi SSID" id="wifiSSID" style="margin-bottom: 10px;">
                    <button class="btn btn-primary" style="width: 100%;" onclick="simulateWiFiConnect()">
                        Connect WiFi
                    </button>
                </div>

                <div class="control-group">
                    <h4>Sensor Data</h4>
                    <label style="color: var(--ctp-subtext1); display: block; margin-bottom: 5px;">Temperature (¬∞C):</label>
                    <input type="range" min="0" max="50" value="25" class="control-input" id="tempSlider" onchange="updateTemperature(this.value)">
                    <span id="tempValue" style="color: var(--ctp-text);">25¬∞C</span>
                </div>

                <div class="control-group">
                    <h4>Custom Command</h4>
                    <input type="text" class="control-input" placeholder="Enter command" id="customCommand" style="margin-bottom: 10px;">
                    <button class="btn btn-primary" style="width: 100%;" onclick="sendCommand()">
                        Send Command
                    </button>
                </div>
            </div>
        </div>

        <!-- Output Console -->
        <div class="simulator-panel">
            <h3 style="color: var(--ctp-text); margin-bottom: 15px;">üìù Serial Output</h3>
            
            <div class="simulator-output" id="serialOutput">
                <div class="output-line info">[INFO] ESP32 Simulator initialized</div>
                <div class="output-line">[DEBUG] Waiting for commands...</div>
            </div>
            
            <div style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="clearOutput()">
                    üóëÔ∏è Clear Output
                </button>
                <button class="btn btn-secondary" onclick="downloadLog()">
                    üíæ Download Log
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    let simulatorRunning = false;
    let gpioStates = {
        2: false,
        4: false,
        builtin: false
    };

    function toggleSimulator() {
        const statusDot = document.getElementById('simulatorStatus');
        const statusText = document.getElementById('statusText');
        const toggleBtn = document.getElementById('toggleSimulator');

        simulatorRunning = !simulatorRunning;

        if (simulatorRunning) {
            statusDot.classList.add('running');
            statusText.textContent = 'Simulator Running';
            toggleBtn.innerHTML = '‚è∏Ô∏è Stop Simulator';
            toggleBtn.classList.remove('btn-primary');
            toggleBtn.classList.add('btn-secondary');
            
            addOutput('success', '[INFO] Simulator started');
            addOutput('info', '[DEBUG] ESP32 boot sequence initiated');
            addOutput('info', '[DEBUG] WiFi stack initialized');
        } else {
            statusDot.classList.remove('running');
            statusText.textContent = 'Simulator Stopped';
            toggleBtn.innerHTML = '‚ñ∂Ô∏è Start Simulator';
            toggleBtn.classList.remove('btn-secondary');
            toggleBtn.classList.add('btn-primary');
            
            addOutput('warning', '[INFO] Simulator stopped');
        }
    }

    function toggleGPIO(pin) {
        if (!simulatorRunning) {
            alert('Please start the simulator first');
            return;
        }

        gpioStates[pin] = !gpioStates[pin];
        const ledElement = document.getElementById(`gpio${pin}LED`);
        
        if (gpioStates[pin]) {
            ledElement.classList.remove('off');
            ledElement.classList.add('on');
            addOutput('success', `[GPIO] GPIO${pin} set to HIGH`);
        } else {
            ledElement.classList.remove('on');
            ledElement.classList.add('off');
            addOutput('info', `[GPIO] GPIO${pin} set to LOW`);
        }
    }

    function toggleBuiltinLED() {
        if (!simulatorRunning) {
            alert('Please start the simulator first');
            return;
        }

        gpioStates.builtin = !gpioStates.builtin;
        const ledElement = document.getElementById('builtinLED');
        
        if (gpioStates.builtin) {
            ledElement.classList.remove('off');
            ledElement.classList.add('on');
            addOutput('success', '[LED] Built-in LED turned ON');
        } else {
            ledElement.classList.remove('on');
            ledElement.classList.add('off');
            addOutput('info', '[LED] Built-in LED turned OFF');
        }
    }

    function simulateWiFiConnect() {
        if (!simulatorRunning) {
            alert('Please start the simulator first');
            return;
        }

        const ssid = document.getElementById('wifiSSID').value;
        if (!ssid) {
            addOutput('error', '[WiFi] ERROR: No SSID provided');
            return;
        }

        addOutput('info', `[WiFi] Attempting to connect to "${ssid}"`);
        setTimeout(() => {
            addOutput('success', `[WiFi] Connected to "${ssid}"`);
            addOutput('info', '[WiFi] IP address: 192.168.1.100');
        }, 2000);
    }

    function updateTemperature(value) {
        document.getElementById('tempValue').textContent = value + '¬∞C';
        
        if (simulatorRunning) {
            addOutput('info', `[SENSOR] Temperature reading: ${value}¬∞C`);
        }
    }

    function sendCommand() {
        if (!simulatorRunning) {
            alert('Please start the simulator first');
            return;
        }

        const command = document.getElementById('customCommand').value;
        if (!command) return;

        addOutput('info', `[CMD] > ${command}`);
        
        // Simulate command responses
        setTimeout(() => {
            if (command.toLowerCase().includes('help')) {
                addOutput('success', '[CMD] Available commands: reset, status, gpio, wifi');
            } else if (command.toLowerCase().includes('status')) {
                addOutput('success', '[CMD] System status: Running, Free heap: 280KB');
            } else {
                addOutput('warning', `[CMD] Unknown command: ${command}`);
            }
        }, 500);

        document.getElementById('customCommand').value = '';
    }

    function addOutput(type, message) {
        const output = document.getElementById('serialOutput');
        const line = document.createElement('div');
        line.className = `output-line ${type}`;
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        
        output.appendChild(line);
        output.scrollTop = output.scrollHeight;
    }

    function clearOutput() {
        document.getElementById('serialOutput').innerHTML = `
            <div class="output-line info">[INFO] Output cleared</div>
        `;
    }

    function downloadLog() {
        const output = document.getElementById('serialOutput').innerText;
        const blob = new Blob([output], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'esp32-simulator-log.txt';
        a.click();
        URL.revokeObjectURL(url);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        addOutput('info', '[SYSTEM] Simulator interface ready');
    });
</script>
{% endblock %}